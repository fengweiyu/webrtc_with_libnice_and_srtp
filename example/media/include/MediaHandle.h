/*****************************************************************************
* Copyright (C) 2017-2018 Hanson Yu  All rights reserved.
------------------------------------------------------------------------------
* File Module		: 	MediaHandle.h
* Description		: 	MediaHandle operation center
* Created			: 	2017.09.21.
* Author			: 	Yu Weifeng
* Function List		: 	
* Last Modified 	: 	
* History			: 	
******************************************************************************/
#ifndef MEDIA_HANDLE_H
#define MEDIA_HANDLE_H

#include <stdlib.h>
#include <stdio.h>
#include <string>

using std::string;


#define FRAME_BUFFER_MAX_SIZE               (2*1024*1024)   //2m
#define MAX_NALU_CNT_ONE_FRAME              12
#define VIDEO_ENC_PARAM_BUF_MAX_LEN     	64

typedef enum
{
	STREAM_TYPE_UNKNOW = 0,
    STREAM_TYPE_VIDEO_STREAM,
    STREAM_TYPE_AUDIO_STREAM,
    STREAM_TYPE_MUX_STREAM,//包含音视频两路裸流
    STREAM_TYPE_FLV_STREAM,
}E_StreamType;

typedef enum
{
	MEDIA_ENCODE_TYPE_UNKNOW = 0,
	MEDIA_ENCODE_TYPE_H264,
    MEDIA_ENCODE_TYPE_H265,
    MEDIA_ENCODE_TYPE_VP8,
    MEDIA_ENCODE_TYPE_VP9,
    MEDIA_ENCODE_TYPE_AAC,
    MEDIA_ENCODE_TYPE_G711U,
    MEDIA_ENCODE_TYPE_G711A,
    MEDIA_ENCODE_TYPE_G726,
}E_MediaEncodeType;

typedef enum
{
	MEDIA_FRAME_TYPE_UNKNOW = 0,
    MEDIA_FRAME_TYPE_VIDEO_I_FRAME,
    MEDIA_FRAME_TYPE_VIDEO_P_FRAME,
    MEDIA_FRAME_TYPE_VIDEO_B_FRAME,
    MEDIA_FRAME_TYPE_AUDIO_FRAME,
        
}E_MediaFrameType;


typedef struct MediaInfo
{
    E_StreamType eStreamType;
    E_MediaEncodeType eVideoEncType;
    unsigned int dwVideoSampleRate;
    E_MediaEncodeType eAudioEncType;
    unsigned int dwAudioSampleRate;
}T_MediaInfo;


typedef struct MediaFrameParam
{
    unsigned char *pbFrameBuf;//缓冲区
    int iFrameBufMaxLen;//缓冲区总大小
    int iFrameBufLen;//缓冲区读到数据的总大小
    int iFrameProcessedLen;
    
	//输出1帧数据结果
    unsigned char *pbFrameStartPos;
    int iFrameLen;
    unsigned int dwNaluCount;
    unsigned int a_dwNaluEndOffset[MAX_NALU_CNT_ONE_FRAME];

    E_MediaFrameType eFrameType;
    int iVideoEncType;
    int iAudioEncType;
    unsigned int dwTimeStamp;
}T_MediaFrameParam;


typedef struct VideoEncodeParam
{
	unsigned char abSPS[VIDEO_ENC_PARAM_BUF_MAX_LEN];
	int iSizeOfSPS;
	unsigned char abPPS[VIDEO_ENC_PARAM_BUF_MAX_LEN];
	int iSizeOfPPS;
	unsigned char abVPS[VIDEO_ENC_PARAM_BUF_MAX_LEN];
	int iSizeOfVPS;
}T_VideoEncodeParam;


typedef struct MediaFrameBufInfo
{
    unsigned char *pbFrameBuf;//缓冲区
    int iFrameBufMaxLen;//缓冲区总大小
    int iFrameBufLen;//缓冲区读到数据的总大小
    int iFrameProcessedLen;
    
    E_StreamType eStreamType;//裸流的帧数据时，这个需要外部赋值然后传入
    E_MediaEncodeType eEncType;//裸流的帧数据时，这个需要外部赋值然后传入
}T_MediaFrameBufInfo;

typedef struct MediaFrameInfo
{
    unsigned char *pbFrameBuf;//缓冲区
    int iFrameBufMaxLen;//缓冲区总大小
    int iFrameBufLen;//缓冲区读到数据的总大小
    int iFrameProcessedLen;
    
    E_StreamType eStreamType;//裸流的帧数据时，这个需要外部赋值然后传入
    E_MediaEncodeType eEncType;//裸流的帧数据时，这个需要外部赋值然后传入
    unsigned int dwTimeStamp;//裸流的帧数据时，这个外部会赋值然后传入
    unsigned int dwSampleRate;//内部判断到不为0，则不会再去赋值
    E_MediaFrameType eFrameType;

	//输出1帧数据结果
    unsigned char *pbFrameStartPos;
    int iFrameLen;
    unsigned int dwNaluCount;//包括sps,pps等参数集对应的nalu
    unsigned int adwNaluEndOffset[MAX_NALU_CNT_ONE_FRAME];
    T_VideoEncodeParam tVideoEncodeParam;
}T_MediaFrameInfo;

/*****************************************************************************
-Class			: MediaHandle
-Description	: 
* Modify Date	  Version		 Author 		  Modification
* -----------------------------------------------
* 2017/09/21	  V1.0.0		 Yu Weifeng 	  Created
******************************************************************************/
class MediaHandle
{
public:
    MediaHandle();
    virtual ~MediaHandle();
    virtual int Init(char *i_strPath);
    virtual int Init(E_StreamType i_eStreamType,E_MediaEncodeType i_eVideoEncType,E_MediaEncodeType i_eAudioEncType);
    
    virtual int GetNextFrame(T_MediaFrameParam *m_ptMediaFrameParam);
    virtual int GetVideoEncParam(T_VideoEncodeParam *o_ptVideoEncodeParam);
    virtual int GetMediaInfo(T_MediaInfo *o_ptMediaInfo);
    //一个接口可以取代前面3个接口，包含Init GetNextFrame GetVideoEncParam GetMediaInfo 功能
    virtual int GetFrame(T_MediaFrameInfo *m_ptFrame);//
protected:
	T_MediaInfo m_tMediaInfo;
	
private:
    MediaHandle             *m_pMediaHandle;//默认VideoHandle(裸流时，表示视频裸数据处理)
    MediaHandle             *m_pMediaAudioHandle;//音视频两路裸流时,这个会被赋值表示音频裸数据处理
    
	FILE                    *m_pMediaFile;
	//unsigned int 			m_dwFileReadOffset;
	
};









#endif
